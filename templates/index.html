<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Yupoo Downloader</title>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface2: #22263a;
      --border: #2e3356;
      --accent: #5b6cf9;
      --accent-glow: rgba(91,108,249,0.25);
      --green: #22c55e;
      --green-dim: rgba(34,197,94,0.15);
      --red: #ef4444;
      --red-dim: rgba(239,68,68,0.12);
      --yellow: #f59e0b;
      --text: #e2e8f0;
      --muted: #64748b;
      --row-hover: #1e2235;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      padding: 32px 24px;
    }
    .page { max-width: 900px; margin: 0 auto; }

    /* Header */
    .header { text-align: center; margin-bottom: 36px; }
    .logo {
      width: 60px; height: 60px;
      background: linear-gradient(135deg, var(--accent), #8b5cf6);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 16px;
      font-size: 28px;
      box-shadow: 0 0 28px var(--accent-glow);
    }
    h1 {
      font-size: 26px; font-weight: 700;
      background: linear-gradient(135deg, #fff 40%, var(--accent));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; margin-bottom: 6px;
    }
    .subtitle { color: var(--muted); font-size: 13px; }

    /* Card */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    /* Column headers */
    .col-headers {
      display: grid;
      grid-template-columns: 1fr 1.6fr 36px;
      gap: 8px;
      padding: 0 4px 8px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 6px;
    }
    .col-header {
      font-size: 11px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--muted);
    }

    /* Rows */
    .rows-container { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1.6fr 36px;
      gap: 8px;
      align-items: center;
      padding: 4px;
      border-radius: 10px;
      transition: background 0.15s;
    }
    .row:hover { background: var(--row-hover); }

    input[type="text"] {
      width: 100%;
      background: var(--bg);
      border: 1.5px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    input[type="text"]::placeholder { color: var(--muted); }
    input[type="text"].has-error { border-color: var(--red); }

    .remove-btn {
      width: 32px; height: 32px;
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--muted);
      font-size: 16px; line-height: 1;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
      padding: 0;
    }
    .remove-btn:hover { border-color: var(--red); color: var(--red); background: var(--red-dim); box-shadow: none; }

    /* Add row / actions */
    .actions-row {
      display: flex; gap: 10px; align-items: center;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }
    .add-btn {
      background: none;
      border: 1.5px dashed var(--border);
      color: var(--muted);
      border-radius: 8px;
      padding: 9px 16px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      flex: 1;
    }
    .add-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); box-shadow: none; }

    .start-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 24px;
      font-size: 14px; font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .start-btn:hover:not(:disabled) { background: #6b7cf9; box-shadow: 0 0 18px var(--accent-glow); }
    .start-btn:disabled { opacity: 0.45; cursor: not-allowed; }

    .hint { color: var(--muted); font-size: 12px; margin-top: 10px; }
    .check { color: var(--green); }
    .cross { color: var(--red); }

    /* Results section */
    .results-section { display: none; }
    .results-section.visible { display: block; }

    .results-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .results-title { font-size: 14px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .results-summary { font-size: 13px; color: var(--muted); }

    /* Job cards */
    .job-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 10px;
      transition: border-color 0.2s;
    }
    .job-card.done { border-color: rgba(34,197,94,0.3); }
    .job-card.error { border-color: rgba(239,68,68,0.3); }

    .job-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .job-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
    .job-dot.running { background: var(--accent); animation: pulse 1.2s infinite; }
    .job-dot.done { background: var(--green); }
    .job-dot.error { background: var(--red); }
    .job-dot.waiting { background: var(--muted); }

    .job-name { font-size: 14px; font-weight: 600; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .job-status { font-size: 12px; color: var(--muted); }

    .job-url { font-size: 11px; color: var(--muted); font-family: monospace; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .progress-track { background: var(--bg); border-radius: 999px; height: 6px; overflow: hidden; margin-bottom: 6px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #8b5cf6); border-radius: 999px; transition: width 0.4s ease; width: 0%; }
    .progress-fill.indeterminate { width: 35%; animation: indeterminate 1.4s infinite ease-in-out; }

    @keyframes indeterminate { 0% { transform: translateX(-200%); } 100% { transform: translateX(500%); } }
    @keyframes pulse {
      0%,100% { opacity:1; box-shadow: 0 0 0 0 var(--accent-glow); }
      50% { opacity:.7; box-shadow: 0 0 0 5px transparent; }
    }

    .job-footer { display: flex; align-items: center; justify-content: space-between; }
    .job-msg { font-size: 12px; color: var(--muted); flex: 1; }
    .job-stats { font-size: 12px; color: var(--muted); }

    .retry-btn {
      background: none;
      border: 1px solid var(--yellow);
      color: var(--yellow);
      border-radius: 7px;
      padding: 7px 14px; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      white-space: nowrap; margin-left: 8px;
    }
    .retry-btn:hover { background: rgba(245,158,11,0.15); box-shadow: none; }

    .dl-btn {
      background: linear-gradient(135deg, var(--green), #16a34a);
      color: #fff; border: none; border-radius: 7px;
      padding: 8px 16px; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      white-space: nowrap; margin-left: 10px;
    }
    .dl-btn:hover { box-shadow: 0 0 18px rgba(34,197,94,0.35); }

    .err-text { font-size: 12px; color: #fca5a5; margin-top: 6px; }

    /* Tips */
    .tips {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 12px; padding: 14px 18px; margin-top: 16px;
    }
    .tips h3 { font-size: 12px; font-weight: 600; color: var(--muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
    .tips ul { list-style: none; display: flex; flex-direction: column; gap: 5px; }
    .tips li { font-size: 12px; color: #94a3b8; padding-left: 14px; position: relative; }
    .tips li::before { content: '&#8594;'; position: absolute; left: 0; color: var(--accent); }
  </style>
</head>
<body>
<div class="page">

  <div class="header">
    <div class="logo">&#128230;</div>
    <h1>Yupoo Downloader</h1>
    <p class="subtitle">Paste multiple album links and download all ZIPs in parallel</p>
  </div>

  <!-- Input card -->
  <div class="card">
    <div class="col-headers">
      <div class="col-header">Album URL</div>
      <div class="col-header">ZIP File Name</div>
      <div></div>
    </div>

    <div class="rows-container" id="rowsContainer"></div>

    <div class="actions-row">
      <button class="add-btn" onclick="addRow()">+ Add another link</button>
      <button class="start-btn" id="startBtn" onclick="startAll()">&#8595; Download All</button>
    </div>

    <p class="hint">
      <span class="check">&#10003; Use direct album links (/albums/)</span>
      &nbsp;&middot;&nbsp;
      <span class="cross">&#10007; Don't use category or store pages</span>
    </p>
  </div>

  <!-- Results -->
  <div class="results-section" id="resultsSection">
    <div class="results-header">
      <div class="results-title">Downloads</div>
      <div class="results-summary" id="resultsSummary"></div>
    </div>
    <div id="jobCards"></div>
  </div>

  <div class="tips">
    <h3>How to use</h3>
    <ul>
      <li>Paste one or more Yupoo album URLs — each must contain <code>/albums/</code></li>
      <li>Give each ZIP a name (optional — defaults to album ID)</li>
      <li>Click Download All — all jobs run at the same time</li>
      <li>Save each ZIP as it finishes — no need to wait for others</li>
    </ul>
  </div>
</div>

<script>
  // ── State ──────────────────────────────────────────────────────────────────
  let rowCount = 0;
  const jobs = {}; // jobId -> { url, name, status, ... }
  let pollTimer = null;

  // ── Row management ─────────────────────────────────────────────────────────
  function addRow(url = '', name = '') {
    rowCount++;
    const id = 'row-' + rowCount;
    const div = document.createElement('div');
    div.className = 'row';
    div.id = id;
    div.innerHTML =
      '<input type="text" class="url-input" placeholder="https://store.x.yupoo.com/albums/123456789" value="' + escHtml(url) + '" autocomplete="off" spellcheck="false" />' +
      '<input type="text" class="name-input" placeholder="e.g. Nike_Air_Max" value="' + escHtml(name) + '" autocomplete="off" spellcheck="false" />' +
      '<button class="remove-btn" onclick="removeRow(\'' + id + '\')" title="Remove">&#215;</button>';
    document.getElementById('rowsContainer').appendChild(div);
    return div;
  }

  function removeRow(id) {
    const el = document.getElementById(id);
    if (el) el.remove();
    // Always keep at least 1 row
    if (document.querySelectorAll('.row').length === 0) addRow();
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ── Start all downloads ────────────────────────────────────────────────────
  async function startAll() {
    const rows = document.querySelectorAll('.row');
    const items = [];
    let hasError = false;

    rows.forEach(row => {
      const urlEl = row.querySelector('.url-input');
      const nameEl = row.querySelector('.name-input');
      const url = urlEl.value.trim();
      const name = nameEl.value.trim();
      urlEl.classList.remove('has-error');

      if (!url) return; // skip empty rows

      if (!url.includes('yupoo.com/albums/')) {
        urlEl.classList.add('has-error');
        hasError = true;
        return;
      }
      items.push({ url, name });
    });

    if (hasError) { alert('One or more URLs are invalid. They must contain /albums/'); return; }
    if (items.length === 0) { alert('Please enter at least one album URL.'); return; }

    document.getElementById('startBtn').disabled = true;
    document.getElementById('resultsSection').classList.add('visible');
    document.getElementById('jobCards').innerHTML = '';
    Object.keys(jobs).forEach(k => delete jobs[k]);

    // Start all jobs in parallel
    await Promise.all(items.map(item => startJob(item.url, item.name)));

    // Begin polling
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(pollAll, 1200);
    pollAll();
  }

  async function startJob(url, name) {
    // Create card immediately in "waiting" state
    const cardId = 'job-' + Date.now() + '-' + Math.random().toString(36).slice(2);
    const displayName = name || albumIdFromUrl(url) || url;

    jobs[cardId] = { url, name: displayName, jobId: null, status: 'waiting' };
    createJobCard(cardId, displayName, url);

    try {
      const res = await fetch('/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, zip_name: name })
      });
      const data = await res.json();
      if (!res.ok || data.error) {
        setJobError(cardId, data.error || 'Failed to start');
        return;
      }
      jobs[cardId].jobId = data.job_id;
      setJobDot(cardId, 'running');
    } catch(e) {
      setJobError(cardId, 'Could not connect to server');
    }
  }

  function albumIdFromUrl(url) {
    const m = url.match(/\/albums\/(\d+)/);
    return m ? 'album_' + m[1] : null;
  }

  // ── Job cards ──────────────────────────────────────────────────────────────
  function createJobCard(cardId, name, url) {
    const card = document.createElement('div');
    card.className = 'job-card';
    card.id = 'card-' + cardId;
    card.innerHTML =
      '<div class="job-header">' +
        '<div class="job-dot waiting" id="dot-' + cardId + '"></div>' +
        '<div class="job-name">' + escHtml(name) + '.zip</div>' +
        '<div class="job-status" id="status-label-' + cardId + '">Waiting...</div>' +
      '</div>' +
      '<div class="job-url">' + escHtml(url) + '</div>' +
      '<div class="progress-track"><div class="progress-fill indeterminate" id="fill-' + cardId + '"></div></div>' +
      '<div class="job-footer">' +
        '<div class="job-msg" id="msg-' + cardId + '">Queued</div>' +
        '<div class="job-stats" id="stats-' + cardId + '"></div>' +
        '<button class="retry-btn" id="retry-' + cardId + '" style="display:none" onclick="retryJob(\'' + cardId + '\')">&#8635; Retry</button>' +
        '<button class="dl-btn" id="dl-' + cardId + '" style="display:none" onclick="triggerDownload(\'' + cardId + '\')">&#11015; Save ZIP</button>' +
      '</div>' +
      '<div class="err-text" id="err-' + cardId + '" style="display:none"></div>';
    document.getElementById('jobCards').appendChild(card);
  }

  function setJobDot(cardId, state) {
    const dot = document.getElementById('dot-' + cardId);
    if (dot) dot.className = 'job-dot ' + state;
    const card = document.getElementById('card-' + cardId);
    if (card) {
      card.classList.remove('done','error');
      if (state === 'done') card.classList.add('done');
      if (state === 'error') card.classList.add('error');
    }
  }

  function setJobError(cardId, msg) {
    jobs[cardId].status = 'error';
    setJobDot(cardId, 'error');
    document.getElementById('msg-' + cardId).textContent = 'Failed';
    document.getElementById('status-label-' + cardId).textContent = 'Error';
    const errEl = document.getElementById('err-' + cardId);
    errEl.textContent = msg;
    errEl.style.display = 'block';
    const fill = document.getElementById('fill-' + cardId);
    fill.className = 'progress-fill';
    fill.style.width = '0%';
    const retryBtn = document.getElementById('retry-' + cardId);
    if (retryBtn) retryBtn.style.display = 'inline-block';
    updateSummary();
  }

  function triggerDownload(cardId) {
    const job = jobs[cardId];
    if (job && job.jobId) {
      window.location.href = '/download/' + job.jobId;
    }
  }

  // ── Polling ────────────────────────────────────────────────────────────────
  async function pollAll() {
    let allDone = true;

    for (const [cardId, job] of Object.entries(jobs)) {
      if (job.status === 'done' || job.status === 'error') continue;
      if (!job.jobId) { allDone = false; continue; }

      allDone = false;
      try {
        const res = await fetch('/status/' + job.jobId);
        const data = await res.json();
        updateJobCard(cardId, data);
      } catch(e) {}
    }

    if (allDone) {
      clearInterval(pollTimer);
      document.getElementById('startBtn').disabled = false;
    }
    updateSummary();
  }

  function updateJobCard(cardId, data) {
    const job = jobs[cardId];
    if (!job) return;

    document.getElementById('msg-' + cardId).textContent = data.message || '';
    document.getElementById('status-label-' + cardId).textContent = capitalise(data.status);

    const fill = document.getElementById('fill-' + cardId);

    if (data.total > 0) {
      const pct = Math.round((data.downloaded / data.total) * 100);
      fill.className = 'progress-fill';
      fill.style.width = pct + '%';
      document.getElementById('stats-' + cardId).textContent = data.downloaded + ' / ' + data.total + ' images';
    }

    if (data.status === 'done') {
      job.status = 'done';
      setJobDot(cardId, 'done');
      fill.className = 'progress-fill';
      fill.style.width = '100%';
      document.getElementById('stats-' + cardId).textContent = data.downloaded + ' images' + (data.failed > 0 ? ', ' + data.failed + ' failed' : '');
      const dlBtn = document.getElementById('dl-' + cardId);
      dlBtn.style.display = 'inline-block';
      // Show retry button if any images failed
      if (data.failed > 0) {
        const retryBtn = document.getElementById('retry-' + cardId);
        if (retryBtn) retryBtn.style.display = 'inline-block';
      }
    }

    if (data.status === 'error') {
      setJobError(cardId, data.message);
      // Show retry on error too
      const retryBtn = document.getElementById('retry-' + cardId);
      if (retryBtn) retryBtn.style.display = 'inline-block';
    }
  }

  async function retryJob(cardId) {
    const job = jobs[cardId];
    if (!job || !job.jobId) return;

    // Reset card visually
    job.status = 'running';
    setJobDot(cardId, 'running');
    document.getElementById('retry-' + cardId).style.display = 'none';
    document.getElementById('err-' + cardId).style.display = 'none';
    document.getElementById('msg-' + cardId).textContent = 'Retrying failed images...';
    const fill = document.getElementById('fill-' + cardId);
    fill.className = 'progress-fill indeterminate';
    fill.style.width = '';

    try {
      await fetch('/retry/' + job.jobId, { method: 'POST' });
      // Resume polling
      if (!pollTimer) {
        pollTimer = setInterval(pollAll, 1200);
      }
    } catch(e) {
      document.getElementById('msg-' + cardId).textContent = 'Retry failed — could not reach server.';
    }
  }

  function updateSummary() {
    const total = Object.keys(jobs).length;
    const done = Object.values(jobs).filter(j => j.status === 'done').length;
    const errors = Object.values(jobs).filter(j => j.status === 'error').length;
    let text = done + ' / ' + total + ' complete';
    if (errors > 0) text += ' (' + errors + ' failed)';
    document.getElementById('resultsSummary').textContent = text;
  }

  function capitalise(s) {
    if (!s) return '';
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  // ── Init: start with 3 empty rows ─────────────────────────────────────────
  addRow();
  addRow();
  addRow();
</script>
</body>
</html>
